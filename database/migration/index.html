<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Migration from SQLite to PostgreSQL - AMY documentation</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Migration from SQLite to PostgreSQL";
    var mkdocs_page_input_path = "database/migration.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> AMY documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../user_guide/">User Guide</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../procedures/">Procedures</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../amy_database_structure/">Database Structure</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../sending_mails/">Sending Mails</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Design</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../design/">Design</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../design/database_models/">Database Models</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../design/template_hierarchy/">Template Hierarchy</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../design/server_infrastructure/">Server Infrastructure</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="" href="../../releases">Releases</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">AMY documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
    
    <li>Migration from SQLite to PostgreSQL</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/carpentries/amy/edit/master/docs/database/migration.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="migration-from-sqlite-to-postgresql">Migration from SQLite to PostgreSQL</h1>
<p>Clear PostgreSQL database with drop/create commands or with <code>manage.py</code>:</p>
<pre><code class="language-postgresql">DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
</code></pre>
<p>or</p>
<pre><code class="language-shell">$ DATABASE_URL=postgresql://amy:...@.../amy python manage.py reset_db
</code></pre>
<p>Migrate the new server with latest migrations:</p>
<pre><code class="language-shell">$ DATABASE_URL=postgresql://amy:...@.../amy python manage.py migrate
</code></pre>
<p>Some of the migrations have data migrations, and create entries in the database. The same data will be included in the database dump from SQLite, so one way to work around this issue is to flush the database (remove existing data):</p>
<pre><code class="language-shell">$ DATABASE_URL=postgresql://amy:...@.../amy python manage.py flush
</code></pre>
<p>Flushing doesn't affect installed permissions, content types and sites. They need to be cleaned individually:</p>
<pre><code class="language-postgresql">TRUNCATE auth_permission CASCADE;
TRUNCATE django_site CASCADE;
TRUNCATE django_content_type CASCADE;
</code></pre>
<p>All these three will be brought back with separate dump.</p>
<p><strong>WARNING!</strong> Don't remove migration data from <code>django_migration</code> table.</p>
<p>Make latest backup of SQLite database:</p>
<pre><code class="language-shell">$ cd /webapps/amy.carpentries.org/repo/ &amp;&amp; sqlite3 db.sqlite3  &quot;.backup newest_backup.sqlite3&quot;
</code></pre>
<p>Prepare data dump with Django:</p>
<pre><code class="language-shell">$ DATABASE_URL=sqlite:///newest_backup.sqlite3 python manage.py dumpdata contenttypes auth.permission sites --indent 1 &gt; data_others.json
$ DATABASE_URL=sqlite:///newest_backup.sqlite3 python manage.py dumpdata -e contenttypes -e auth.permission -e sites --indent 1 &gt; data.json
</code></pre>
<p>Load the first dump into PostgreSQL:</p>
<pre><code class="language-shell">$ DATABASE_URL=postgresql://amy:...@.../amy python manage.py loaddata data_others.json
</code></pre>
<p><strong>Verify the number of objects installed: 311.</strong></p>
<p>Load the second dump into PostgreSQL:</p>
<pre><code class="language-shell">$ DATABASE_URL=postgresql://amy:...@.../amy python manage.py loaddata data.json
</code></pre>
<p><strong>Verify the number of objects installed: 353514 (or more).</strong></p>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/carpentries/amy/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
